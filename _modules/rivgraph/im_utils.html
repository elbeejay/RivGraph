

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>rivgraph.im_utils &mdash; RivGraph 0.3 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/index.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../background/index.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/index.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apiref/index.html">API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">RivGraph</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>rivgraph.im_utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for rivgraph.im_utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">im_utils</span>
<span class="sd">========</span>

<span class="sd">Created on Mon Sep 10 10:21:35 2018</span>

<span class="sd">@author: Jon</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">nd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">morphology</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">import</span> <span class="nn">rivgraph.geo_utils</span> <span class="k">as</span> <span class="nn">gu</span>


<div class="viewcode-block" id="get_array"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.get_array">[docs]</a><span class="k">def</span> <span class="nf">get_array</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Size is (nrows, ncols) corresponding to the number of rows, columns to return with</span>
<span class="sd">    idx at the center. idx can be flattend index or [row, col]</span>

<span class="sd">    ## Should add check for border cases so we don&#39;t query to raster</span>
<span class="sd">    ## beyond its bounds</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dims</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">lidx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">lidx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">idx</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">lidx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Get row, column of top-left most pixel in array</span>
    <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span> <span class="o">-</span> <span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col</span> <span class="o">-</span> <span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">array</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">row</span><span class="p">:</span><span class="n">row</span><span class="o">+</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">col</span><span class="p">:</span><span class="n">col</span><span class="o">+</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">array</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span></div>


<div class="viewcode-block" id="neighbors_flat"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.neighbors_flat">[docs]</a><span class="k">def</span> <span class="nf">neighbors_flat</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">imflat</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s1">&#39;nonzero&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a flattened image (np.ravel) and an index, returns all the</span>
<span class="sd">    neighboring indices and their values. Uses native python datatypes.</span>
<span class="sd">    Set filt=&#39;nonzero&#39; for returning only nonzero indices; otherwise set</span>
<span class="sd">    filt=&#39;none&#39; to return all indices and values.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">generic</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ncols</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">generic</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="n">dy</span> <span class="o">=</span> <span class="n">ncols</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">possneighs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">idx</span><span class="o">-</span><span class="n">dy</span><span class="o">-</span><span class="n">dx</span><span class="p">,</span>
                  <span class="n">idx</span><span class="o">-</span><span class="n">dy</span><span class="p">,</span>
                  <span class="n">idx</span><span class="o">-</span><span class="n">dy</span><span class="o">+</span><span class="n">dx</span><span class="p">,</span>
                  <span class="n">idx</span><span class="o">-</span><span class="n">dx</span><span class="p">,</span>
                  <span class="n">idx</span><span class="o">+</span><span class="n">dx</span><span class="p">,</span>
                  <span class="n">idx</span><span class="o">+</span><span class="n">dy</span><span class="o">-</span><span class="n">dx</span><span class="p">,</span>
                  <span class="n">idx</span><span class="o">+</span><span class="n">dy</span><span class="p">,</span>
                  <span class="n">idx</span><span class="o">+</span><span class="n">dy</span><span class="o">+</span><span class="n">dx</span><span class="p">])</span>

    <span class="c1"># For handling edge cases</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># first column of image</span>

        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ncols</span><span class="p">:</span> <span class="c1"># top row of image</span>
            <span class="n">pullvals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imflat</span><span class="p">)</span> <span class="o">-</span> <span class="n">ncols</span><span class="p">:</span> <span class="c1"># bottom row of image</span>
            <span class="n">pullvals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pullvals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">]</span>

    <span class="k">elif</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># last column of image</span>

        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ncols</span><span class="p">:</span> <span class="c1"># top row</span>
            <span class="n">pullvals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imflat</span><span class="p">)</span> <span class="o">-</span> <span class="n">ncols</span><span class="p">:</span> <span class="c1"># bottom row of image</span>
            <span class="n">pullvals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pullvals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ncols</span><span class="p">:</span>
        <span class="n">pullvals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imflat</span><span class="p">)</span> <span class="o">-</span> <span class="n">ncols</span><span class="p">:</span> <span class="c1"># bottom row of image</span>
        <span class="n">pullvals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># Regular cases (non-edges)</span>
        <span class="n">pullvals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">]</span>

    <span class="n">idcs</span> <span class="o">=</span> <span class="n">possneighs</span><span class="p">[</span><span class="n">pullvals</span><span class="p">]</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">imflat</span><span class="p">[</span><span class="n">idcs</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">filt</span> <span class="o">==</span> <span class="s1">&#39;nonzero&#39;</span><span class="p">:</span>
        <span class="n">keepidcs</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">idcs</span> <span class="o">=</span> <span class="n">idcs</span><span class="p">[</span><span class="n">keepidcs</span><span class="p">]</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">keepidcs</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">idcs</span><span class="p">,</span> <span class="n">vals</span></div>


<div class="viewcode-block" id="reglobalize_flat_idx"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.reglobalize_flat_idx">[docs]</a><span class="k">def</span> <span class="nf">reglobalize_flat_idx</span><span class="p">(</span><span class="n">idxlist</span><span class="p">,</span> <span class="n">idxlistdims</span><span class="p">,</span> <span class="n">row_offset</span><span class="p">,</span> <span class="n">col_offset</span><span class="p">,</span> <span class="n">globaldims</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If idxlist is (x,y), then idxlistdims should be (dim_x, dim_y), etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">convertflag</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">idxlist</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">idxlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">idxlist</span><span class="p">]</span>
        <span class="n">convertflag</span> <span class="o">=</span> <span class="s1">&#39;int&#39;</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">idxlist</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">:</span>
        <span class="n">idxlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">idxlist</span><span class="p">)</span>
        <span class="n">convertflag</span> <span class="o">=</span> <span class="s1">&#39;set&#39;</span>

    <span class="n">idcsrowcol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">idxlist</span><span class="p">,</span> <span class="n">idxlistdims</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">idcsrowcol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">row_offset</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">idcsrowcol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">col_offset</span>
    <span class="n">idcsflat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">),</span> <span class="n">globaldims</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">convertflag</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span>
        <span class="n">idcsflat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idcsflat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">convertflag</span> <span class="o">==</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span>
        <span class="n">idcsflat</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">idcsflat</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">idcsflat</span></div>


<div class="viewcode-block" id="nfour_connectivity"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.nfour_connectivity">[docs]</a><span class="k">def</span> <span class="nf">nfour_connectivity</span><span class="p">(</span><span class="n">I</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an image of four-connectivity for each pixel, where the pixel value</span>
<span class="sd">    is the number of 4-connected neighbors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Ir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
    <span class="n">edgeidcs</span> <span class="o">=</span> <span class="n">edge_coords</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span><span class="p">)</span>

    <span class="n">allpix</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Ir</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">dopix</span> <span class="o">=</span> <span class="n">allpix</span> <span class="o">-</span> <span class="n">edgeidcs</span>
    <span class="n">savepix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dopix</span><span class="p">)</span>

    <span class="n">fourconnidcs</span> <span class="o">=</span> <span class="n">four_conn</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dopix</span><span class="p">),</span> <span class="n">I</span><span class="p">)</span>
    <span class="n">n_fourconn</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="n">fourconnidcs</span><span class="p">]</span>

    <span class="n">Infc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Ir</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">Infc</span><span class="p">[</span><span class="n">savepix</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_fourconn</span>
    <span class="n">Infc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Infc</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Infc</span></div>


<div class="viewcode-block" id="four_conn"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.four_conn">[docs]</a><span class="k">def</span> <span class="nf">four_conn</span><span class="p">(</span><span class="n">idcs</span><span class="p">,</span> <span class="n">I</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Counts the number of 4-connected neighbors for a given flat index in I.</span>
<span class="sd">    idcs must be a list, even if a single value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Iflat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">))</span>

    <span class="n">fourconn</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idcs</span><span class="p">:</span>
        <span class="n">neigh_idcs</span> <span class="o">=</span> <span class="n">neighbors_flat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Iflat</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ni_check</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">neigh_idcs</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">fourconn</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">neigh_idcs</span><span class="p">)</span> <span class="k">if</span> <span class="n">ni_check</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ni_check</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

    <span class="k">return</span> <span class="n">fourconn</span></div>


<div class="viewcode-block" id="edge_coords"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.edge_coords">[docs]</a><span class="k">def</span> <span class="nf">edge_coords</span><span class="p">(</span><span class="n">sizeI</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an image size, returns the coordinates of all the edge pixels (4 edges).</span>
<span class="sd">    Can return as indices (dtype=flat) or x,y coordinates (dtyep=&#39;xy&#39;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># xs</span>
    <span class="n">x_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sizeI</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">x_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sizeI</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">x_r</span> <span class="o">=</span> <span class="n">x_l</span> <span class="o">+</span> <span class="n">sizeI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">x_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">x_b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># ys</span>
    <span class="n">y_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sizeI</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">y_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">y_l</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">y_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sizeI</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">y_b</span> <span class="o">=</span> <span class="n">y_t</span> <span class="o">+</span> <span class="n">sizeI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">edgeptx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x_l</span><span class="p">,</span> <span class="n">x_b</span><span class="p">,</span> <span class="n">x_r</span><span class="p">,</span> <span class="n">x_t</span><span class="p">])</span>
    <span class="n">edgepty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_l</span><span class="p">,</span> <span class="n">y_b</span><span class="p">,</span> <span class="n">y_r</span><span class="p">,</span> <span class="n">y_t</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;flat&#39;</span><span class="p">:</span>
        <span class="n">edgepts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">((</span><span class="n">edgepty</span><span class="p">,</span> <span class="n">edgeptx</span><span class="p">),</span> <span class="n">sizeI</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
        <span class="n">edgepts</span> <span class="o">=</span> <span class="p">[</span><span class="n">edgeptx</span><span class="p">,</span> <span class="n">edgepty</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">edgepts</span></div>


<div class="viewcode-block" id="neighbor_idcs"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.neighbor_idcs">[docs]</a><span class="k">def</span> <span class="nf">neighbor_idcs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Input x,y coordinates and return all the neighbor indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xidcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">yidcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">xidcs</span><span class="p">,</span> <span class="n">yidcs</span></div>


<span class="k">def</span> <span class="nf">neighbor_vals</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>

    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">vals</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">y</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">im</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">y</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vals</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">y</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
        <span class="n">vals</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">neighbor_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="c1"># Feed in x, y location and a neighbor index</span>
    <span class="c1"># Return the x, y location of the neighbor</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">xs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">ys</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>


<div class="viewcode-block" id="remove_blobs"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.remove_blobs">[docs]</a><span class="k">def</span> <span class="nf">remove_blobs</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">blobthresh</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a binary image with blobs less than size blobthresh removed from</span>
<span class="sd">    the input binary image.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="s1">&#39;coords&#39;</span><span class="p">]</span>
    <span class="n">rp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">regionprops</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="n">connectivity</span><span class="p">)</span>
    <span class="n">areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rp</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">])</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">rp</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span>

    <span class="n">remove_idcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">areas</span> <span class="o">&lt;</span> <span class="n">blobthresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">Ic</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">remove_idcs</span><span class="p">:</span>
        <span class="n">Ic</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="n">r</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span><span class="n">coords</span><span class="p">[</span><span class="n">r</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">Ic</span></div>


<span class="k">def</span> <span class="nf">imshowpair</span><span class="p">(</span><span class="n">I1</span><span class="p">,</span> <span class="n">I2</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colors</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
    <span class="n">Ip</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">I1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
    <span class="n">Ip</span><span class="p">[</span><span class="n">I1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">Ip</span><span class="p">[</span><span class="n">I2</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">Ip</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">I1</span><span class="p">,</span> <span class="n">I2</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">([</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;magenta&#39;</span><span class="p">,</span> <span class="s1">&#39;lime&#39;</span><span class="p">])</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">,</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">3.5</span><span class="p">]</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>

    <span class="c1"># tell imshow about color map so that only set colors are used</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Ip</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>

<span class="c1">#    img = plt.imshow(Ip, origin=&#39;upper&#39;,</span>
<span class="c1">#                        cmap=cmap, norm=norm)</span>
<span class="c1">#    # make a color bar</span>
<span class="c1">#    plt.colorbar(img, cmap=cmap, norm=norm, boundaries=bounds, ticks=[0, 5, 10])</span>


<span class="c1">#def fill_islands(I, min_n_island_pixels=20):</span>
<span class="c1">#</span>
<span class="c1">#    # Invert binary image</span>
<span class="c1">#    Icomp = util.invert(I)</span>
<span class="c1">#</span>
<span class="c1">#    # Compute region props</span>
<span class="c1">#    props = [&#39;coords&#39;,&#39;area&#39;]</span>
<span class="c1">#    rp = regionprops(Icomp, props, connectivity=1)</span>
<span class="c1">#    for a, c in zip(rp[&#39;area&#39;], rp[&#39;coords&#39;]):</span>
<span class="c1">#        if a &lt; min_n_island_pixels:</span>
<span class="c1">#            I[c[:,0], c[:,1]] = True</span>
<span class="c1">#    return I</span>


<div class="viewcode-block" id="largest_blobs"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.largest_blobs">[docs]</a><span class="k">def</span> <span class="nf">largest_blobs</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">nlargest</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a binary image with the nlargest blobs removed from the input</span>
<span class="sd">    binary image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="s1">&#39;coords&#39;</span><span class="p">]</span>
    <span class="n">rp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">regionprops</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="n">connectivity</span><span class="p">)</span>
    <span class="n">areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rp</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">])</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">rp</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span>
    <span class="c1"># Sorts the areas array and keeps the nlargest indices</span>
    <span class="n">maxidcs</span> <span class="o">=</span> <span class="n">areas</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[</span><span class="o">-</span><span class="n">nlargest</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;remove&#39;</span><span class="p">:</span>
        <span class="n">Ic</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">maxidcs</span><span class="p">:</span>
            <span class="n">Ic</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="n">m</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span><span class="n">coords</span><span class="p">[</span><span class="n">m</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;keep&#39;</span><span class="p">:</span>
        <span class="n">Ic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">maxidcs</span><span class="p">:</span>
            <span class="n">Ic</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="n">m</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span><span class="n">coords</span><span class="p">[</span><span class="n">m</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Improper action specified: either choose remove or keep&#39;</span><span class="p">)</span>
        <span class="n">Ic</span> <span class="o">=</span> <span class="n">I</span>

    <span class="k">return</span> <span class="n">Ic</span></div>


<div class="viewcode-block" id="blob_idcs"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.blob_idcs">[docs]</a><span class="k">def</span> <span class="nf">blob_idcs</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list where each entry contains a set of all indices within each</span>
<span class="sd">    connected blob. Indices are returned as single-index coordinates, rather</span>
<span class="sd">    than x,y.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span>
    <span class="n">rp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">regionprops</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="n">connectivity</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">rp</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span>
    <span class="n">idcs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
        <span class="n">idcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">([</span><span class="n">c</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">idcs</span></div>


<span class="k">def</span> <span class="nf">regionprops</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    
    <span class="c1">### TODO: Add a check that appropriate props are requested</span>

    <span class="n">Ilabeled</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="n">connectivity</span><span class="p">)</span>
    <span class="n">properties</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">Ilabeled</span><span class="p">,</span> <span class="n">intensity_image</span><span class="o">=</span><span class="n">I</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Get the coordinates of each blob in case we need them later</span>
    <span class="k">if</span> <span class="s1">&#39;coords&#39;</span> <span class="ow">in</span> <span class="n">props</span> <span class="ow">or</span> <span class="s1">&#39;perimeter&#39;</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">coords</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;area&#39;</span><span class="p">:</span>
            <span class="n">allprop</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">area</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;coords&#39;</span><span class="p">:</span>
            <span class="n">allprop</span> <span class="o">=</span> <span class="n">coords</span>
        <span class="k">elif</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;centroid&#39;</span><span class="p">:</span>
            <span class="n">allprop</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">centroid</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
            <span class="n">allprop</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">mean_intensity</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;perim_len&#39;</span><span class="p">:</span>
            <span class="n">allprop</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">perimeter</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;perimeter&#39;</span><span class="p">:</span>
            <span class="n">perim</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">blob</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
                <span class="c1"># Crop to blob to reduce cv2 computation time and save memory</span>
                <span class="n">Ip</span><span class="p">,</span> <span class="n">pads</span> <span class="o">=</span> <span class="n">crop_binary_coords</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="n">npad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">Ip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Ip</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>

                <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">Ip</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_TREE</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_NONE</span><span class="p">)</span>
                <span class="c1"># IMPORTANT: findContours returns points as (x,y) rather than (row, col)</span>
                <span class="n">contours</span> <span class="o">=</span> <span class="n">contours</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">crows</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ccols</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
                    <span class="n">crows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pads</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># must add back the cropped rows and columns</span>
                    <span class="n">ccols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">cont_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">crows</span><span class="p">,</span><span class="n">ccols</span><span class="p">)))</span> <span class="c1"># format the output</span>
                <span class="n">perim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cont_np</span><span class="p">)</span>
            <span class="n">allprop</span> <span class="o">=</span> <span class="n">perim</span>
        <span class="k">elif</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;convex_area&#39;</span><span class="p">:</span>
            <span class="n">allprop</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">convex_area</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;eccentricity&#39;</span><span class="p">:</span>
            <span class="n">allprop</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">eccentricity</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;equivalent_diameter&#39;</span><span class="p">:</span>
            <span class="n">allprop</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">equivalent_diameter</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;major_axis_length&#39;</span><span class="p">:</span>
            <span class="n">allprop</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">major_axis_length</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;minor_axis_length&#39;</span><span class="p">:</span>
            <span class="n">allprop</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">minor_axis_length</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span>
            <span class="n">allprop</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not a valid property.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prop</span><span class="p">))</span>

        <span class="n">out</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">allprop</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">Ilabeled</span>


<span class="k">def</span> <span class="nf">erode</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">strel</span><span class="o">=</span><span class="s1">&#39;square&#39;</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">I</span>

    <span class="k">if</span> <span class="n">strel</span> <span class="o">==</span> <span class="s1">&#39;square&#39;</span><span class="p">:</span>
        <span class="n">selem</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">strel</span> <span class="o">==</span> <span class="s1">&#39;plus&#39;</span><span class="p">:</span>
        <span class="n">selem</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">diamond</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">strel</span> <span class="o">==</span> <span class="s1">&#39;disk&#39;</span><span class="p">:</span>
        <span class="n">selem</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">erosion</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">I</span>


<span class="k">def</span> <span class="nf">dilate</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">strel</span><span class="o">=</span><span class="s1">&#39;square&#39;</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">I</span>

    <span class="k">if</span> <span class="n">strel</span> <span class="o">==</span> <span class="s1">&#39;square&#39;</span><span class="p">:</span>
        <span class="n">selem</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">strel</span> <span class="o">==</span> <span class="s1">&#39;plus&#39;</span><span class="p">:</span>
        <span class="n">selem</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">diamond</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">strel</span> <span class="o">==</span> <span class="s1">&#39;disk&#39;</span><span class="p">:</span>
        <span class="n">selem</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">disk</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="n">I</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">dilation</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">selem</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">I</span>



<div class="viewcode-block" id="trim_idcs"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.trim_idcs">[docs]</a><span class="k">def</span> <span class="nf">trim_idcs</span><span class="p">(</span><span class="n">imshape</span><span class="p">,</span> <span class="n">idcs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trims a list of x,y indices by removing rows containing indices that cannot</span>
<span class="sd">    fit within a raster of imshape</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">idcs</span> <span class="o">=</span> <span class="n">idcs</span><span class="p">[</span><span class="n">idcs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">imshape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span>
    <span class="n">idcs</span> <span class="o">=</span> <span class="n">idcs</span><span class="p">[</span><span class="n">idcs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">imshape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span>
    <span class="n">idcs</span> <span class="o">=</span> <span class="n">idcs</span><span class="p">[</span><span class="n">idcs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">idcs</span> <span class="o">=</span> <span class="n">idcs</span><span class="p">[</span><span class="n">idcs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">idcs</span></div>


<div class="viewcode-block" id="crop_binary_im"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.crop_binary_im">[docs]</a><span class="k">def</span> <span class="nf">crop_binary_im</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Crops a binary image to the smallest bounding box containing all the blobs</span>
<span class="sd">    in the image.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">I</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">uly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ulx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">lry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">lrx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">Icrop</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">uly</span><span class="p">:</span><span class="n">lry</span><span class="p">,</span> <span class="n">ulx</span><span class="p">:</span><span class="n">lrx</span><span class="p">]</span>
    <span class="n">pads</span> <span class="o">=</span> <span class="p">[</span><span class="n">ulx</span><span class="p">,</span> <span class="n">uly</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">lrx</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">lry</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">Icrop</span><span class="p">,</span> <span class="n">pads</span></div>


<span class="k">def</span> <span class="nf">crop_binary_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">npad</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

    <span class="c1"># Coords are of format [row, col]</span>

    <span class="n">uly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">npad</span>
    <span class="n">ulx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">npad</span>
    <span class="n">lry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">npad</span>
    <span class="n">lrx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">npad</span>

    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">lry</span><span class="o">-</span><span class="n">uly</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">lrx</span><span class="o">-</span><span class="n">ulx</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">I</span><span class="p">[</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">uly</span><span class="p">,</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ulx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">pads</span> <span class="o">=</span> <span class="p">[</span><span class="n">ulx</span><span class="p">,</span> <span class="n">uly</span><span class="p">,</span> <span class="n">lrx</span><span class="p">,</span> <span class="n">lry</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">I</span><span class="p">,</span> <span class="n">pads</span>


<span class="k">def</span> <span class="nf">fill_holes</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">maxholesize</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">maxholesize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">binary_fill_holes</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">I</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fill only holes less than maxholesize</span>
        <span class="n">Icomp</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>

        <span class="c1"># Remove boundary pixels so holes created by image boundary are not considered blobs</span>
        <span class="n">Icomp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Icomp</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Icomp</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Icomp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Get blob properties of complement image</span>
        <span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">,</span><span class="s1">&#39;area&#39;</span><span class="p">]</span>
        <span class="n">rp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">regionprops</span><span class="p">(</span><span class="n">Icomp</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Blob indices less than specified threshold</span>
        <span class="n">keepidcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rp</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">maxholesize</span><span class="p">]</span>

        <span class="c1"># Fill &#39;dem holes!</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keepidcs</span><span class="p">:</span>
            <span class="n">I</span><span class="p">[</span><span class="n">rp</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span><span class="n">rp</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">I</span>


<div class="viewcode-block" id="im_connectivity"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.im_connectivity">[docs]</a><span class="k">def</span> <span class="nf">im_connectivity</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an image of 8-connectivity for an input image of all pixels in a</span>
<span class="sd">    binary image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Fix input</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">im</span><span class="p">[</span><span class="n">im</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

    <span class="n">src_depth</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">filter2D</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">src_depth</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
    <span class="n">Iret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">filtered</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
    <span class="n">Iret</span><span class="p">[</span><span class="n">filtered</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered</span><span class="p">[</span><span class="n">filtered</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">]</span><span class="o">-</span><span class="mi">10</span>
    <span class="k">return</span> <span class="n">Iret</span></div>


<div class="viewcode-block" id="downsample_binary_image"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.downsample_binary_image">[docs]</a><span class="k">def</span> <span class="nf">downsample_binary_image</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">newsize</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an input binary image and a new size, this downsamples (i.e. reduces</span>
<span class="sd">    resolution) the input image to the new size. A pixel is considered &quot;on&quot;</span>
<span class="sd">    in the new image if &#39;thresh&#39; fraction of its area is covered by the</span>
<span class="sd">    higher-res image. E.g. set &#39;thresh&#39; to zero if you want the output image</span>
<span class="sd">    to be &quot;on&quot; everywhere at least a single pixel is &quot;on&quot; in the original</span>
<span class="sd">    image.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get locations of all smaller pixels</span>
    <span class="n">row</span><span class="p">,</span><span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">I</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Get the scaling factor in both directions</span>
    <span class="n">rowfact</span> <span class="o">=</span> <span class="n">newsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">colfact</span> <span class="o">=</span> <span class="n">newsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Scale the row,col coordinates and turn them into integers</span>
    <span class="n">rowcol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span> <span class="o">*</span> <span class="n">rowfact</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">col</span> <span class="o">*</span> <span class="n">colfact</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)))</span>

    <span class="c1"># Get the number of smaller pixels within each larger pixel</span>
    <span class="n">rc_unique</span><span class="p">,</span> <span class="n">rc_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rowcol</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Filter out the large-pixel coordinates that don&#39;t contain enough area</span>
    <span class="n">area_ratio</span> <span class="o">=</span> <span class="n">rowfact</span> <span class="o">*</span> <span class="n">colfact</span>
    <span class="n">area_fracs</span> <span class="o">=</span> <span class="n">rc_counts</span> <span class="o">*</span> <span class="n">area_ratio</span>
    <span class="n">rc_unique</span> <span class="o">=</span> <span class="n">rc_unique</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">area_fracs</span><span class="o">&gt;=</span><span class="n">thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="c1"># Create the downsampled image</span>
    <span class="n">Iout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">newsize</span><span class="p">)</span>
    <span class="n">Iout</span><span class="p">[</span><span class="n">rc_unique</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">rc_unique</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">Iout</span></div>


<div class="viewcode-block" id="skel_endpoints"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.skel_endpoints">[docs]</a><span class="k">def</span> <span class="nf">skel_endpoints</span><span class="p">(</span><span class="n">skel</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    For a given input skeleton image/array, returns the x,y coordinates of</span>
<span class="sd">    the endpoints (eps).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">Ic</span> <span class="o">=</span> <span class="n">im_connectivity</span><span class="p">(</span><span class="n">skel</span><span class="p">)</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Ic</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">eps</span></div>


<div class="viewcode-block" id="skel_branchpoints"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.skel_branchpoints">[docs]</a><span class="k">def</span> <span class="nf">skel_branchpoints</span><span class="p">(</span><span class="n">Iskel</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    For a given input skeleton image/array, returns the x,y coordinates of the</span>
<span class="sd">    branchpoints.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">Ibps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span><span class="n">im_connectivity</span><span class="p">(</span><span class="n">Iskel</span><span class="p">))</span>

    <span class="c1"># Initial branchpoints are defined by pixels with conn &gt; 2</span>
    <span class="n">Ibps</span><span class="p">[</span><span class="n">Ibps</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Ibps</span><span class="p">[</span><span class="n">Ibps</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1">#    Ibps_O = np.copy(Ibps)</span>

    <span class="c1"># Filter branchpoints using convolution kernel that results in a unique</span>
    <span class="c1"># value for each possible configuration</span>

    <span class="c1"># Create kernel</span>
    <span class="n">kern</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>

    <span class="c1"># Patterns whose center branchpoints we want to remove</span>
    <span class="n">basepat</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">basepat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">]))</span> <span class="c1"># 3.1</span>
    <span class="n">basepat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">]))</span> <span class="c1"># 4.1</span>
    <span class="n">basepat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">]))</span> <span class="c1"># 4.2</span>
    <span class="n">basepat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">]))</span> <span class="c1"># 4.3</span>
<span class="c1">#    basepat.append(np.array([ [0, 0, 0], [0, 1, 1], [1, 1, 0] ])) # 4.4</span>
    <span class="n">basepat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="p">]))</span> <span class="c1"># 4.5</span>
<span class="c1">#    basepat.append(np.array([ [0, 1, 0], [1, 1, 1], [0, 0, 0] ])) # 4.6</span>
    <span class="n">basepat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">]))</span> <span class="c1"># 5.1</span>
    <span class="n">basepat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">]))</span> <span class="c1"># 5.2</span>
    <span class="n">basepat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="p">]))</span> <span class="c1"># 5.3</span>

    <span class="n">rmvals</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">bp</span> <span class="ow">in</span> <span class="n">basepat</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">rmvals</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kern</span><span class="p">[</span><span class="n">bp</span><span class="o">==</span><span class="mi">1</span><span class="p">]))])</span>
            <span class="n">bp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">bp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">rmvals</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kern</span><span class="p">[</span><span class="n">bp</span><span class="o">==</span><span class="mi">1</span><span class="p">]))])</span>
            <span class="n">bp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">bp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">rmvals</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kern</span><span class="p">[</span><span class="n">bp</span><span class="o">==</span><span class="mi">1</span><span class="p">]))])</span>
            <span class="n">bp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Add three more cases where a 2x2 block of branchpoints exists. In these</span>
    <span class="c1"># cases, we choose the top-right one to be the only branchpoint.</span>
    <span class="n">rmvals</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="mi">27</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">432</span><span class="p">,</span> <span class="mi">283</span><span class="p">,</span> <span class="mi">433</span><span class="p">,</span> <span class="mi">118</span><span class="p">])</span>

    <span class="c1"># Convolve</span>
    <span class="n">src_depth</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">Iconv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">filter2D</span><span class="p">(</span><span class="n">Ibps</span><span class="p">,</span> <span class="n">src_depth</span><span class="p">,</span> <span class="n">kern</span><span class="p">)</span>

    <span class="c1"># Remove unwanted branchpoints based on patterns</span>
    <span class="n">Irm_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">Iconv</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">rmvals</span><span class="p">))</span>
    <span class="n">rmy</span><span class="p">,</span> <span class="n">rmx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Irm_flat</span><span class="o">==</span><span class="mi">1</span><span class="p">),</span> <span class="n">Iconv</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Ibps</span><span class="p">[</span><span class="n">rmy</span><span class="p">,</span> <span class="n">rmx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Filter remaining branchpoints: cases where there are two 4-connected branchpoints</span>
    <span class="c1"># Count the neighbors, remove the one with fewer neighbors. Neighbors are</span>
    <span class="c1"># counted distinctly, i.e. none are shared between the two branchpoints when counting.</span>
    <span class="c1"># Find all the cases</span>
    <span class="n">rp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">regionprops</span><span class="p">(</span><span class="n">Ibps</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">,</span><span class="s1">&#39;coords&#39;</span><span class="p">],</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">idcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rp</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idcs</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">rp</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="c1"># coordinates of both 4-connected branchpoint pixels</span>

        <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span> <span class="c1"># Left-right orientation</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># First pixel is left-most</span>
                <span class="n">lneigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">lneighsum</span> <span class="o">=</span> <span class="n">lneigh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">lneigh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lneigh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">lneigh</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">lneigh</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                <span class="n">rneigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">rneighsum</span> <span class="o">=</span> <span class="n">rneigh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rneigh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">rneigh</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">rneigh</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">rneigh</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">lneighsum</span> <span class="o">&gt;</span> <span class="n">rneighsum</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">rneighsum</span> <span class="o">&gt;</span> <span class="n">lneighsum</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># Second pixel is left-most</span>
                <span class="n">lneigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">lneighsum</span> <span class="o">=</span> <span class="n">lneigh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">lneigh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lneigh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">lneigh</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">lneigh</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                <span class="n">rneigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">rneighsum</span> <span class="o">=</span> <span class="n">rneigh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rneigh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">rneigh</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">rneigh</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">rneigh</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">lneighsum</span> <span class="o">&gt;</span> <span class="n">rneighsum</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">rneighsum</span> <span class="o">&gt;</span> <span class="n">lneighsum</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># Up-down orientation</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span> <span class="c1"># First pixel is up-most</span>
                <span class="n">uneigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">uneighsum</span> <span class="o">=</span> <span class="n">uneigh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">uneigh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">uneigh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">uneigh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">uneigh</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">dneigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">dneighsum</span> <span class="o">=</span> <span class="n">dneigh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">dneigh</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">dneigh</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">dneigh</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">dneigh</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">uneighsum</span> <span class="o">&gt;</span> <span class="n">dneighsum</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">dneighsum</span> <span class="o">&gt;</span> <span class="n">uneighsum</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># Second pixel is up-most</span>
                <span class="n">uneigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">uneighsum</span> <span class="o">=</span> <span class="n">uneigh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">uneigh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">uneigh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">uneigh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">uneigh</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">dneigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">dneighsum</span> <span class="o">=</span> <span class="n">dneigh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">dneigh</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">dneigh</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">dneigh</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">dneigh</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">uneighsum</span> <span class="o">&gt;</span> <span class="n">dneighsum</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">dneighsum</span> <span class="o">&gt;</span> <span class="n">uneighsum</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Now handle the cases where there are three branchpoints in a row/column</span>
    <span class="n">idcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rp</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idcs</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">rp</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">c</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])))</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># Vertical</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span> <span class="c1"># First pixel is up-most</span>
                <span class="c1"># Check if end pixels can be removed</span>
                <span class="n">e1_neigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">e1_sum</span> <span class="o">=</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">e1_sum</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">e2_neigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">e2_sum</span> <span class="o">=</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">e2_sum</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># First pixel is right-most</span>
                <span class="n">e1_neigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">e1_sum</span> <span class="o">=</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">e1_sum</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">e2_neigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">e2_sum</span> <span class="o">=</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">e2_sum</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Check if middle pixels can be removed</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">pneigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">psum</span> <span class="o">=</span> <span class="n">pneigh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">pneigh</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">psum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">c</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])))</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># Horizontal</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># First pixel is left-most</span>
                <span class="c1"># Check if end pixels can be removed</span>
                <span class="n">e1_neigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">e1_sum</span> <span class="o">=</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">e1_sum</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">e2_neigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">e2_sum</span> <span class="o">=</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">e2_sum</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># First pixel is right-most</span>
                <span class="n">e1_neigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">e1_sum</span> <span class="o">=</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">e1_neigh</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">e1_sum</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">e2_neigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">e2_sum</span> <span class="o">=</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">e2_neigh</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">e2_sum</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Check if middle pixels can be removed</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">pneigh</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">psum</span> <span class="o">=</span> <span class="n">pneigh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pneigh</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">psum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Ibps</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1">#    # This dangerously assumes that coordinates are returned in order...was the case for all tests run. If there are problems, revisit this!</span>
<span class="c1">#    idcs = np.where(rp[&#39;area&#39;]==3)[0]</span>
<span class="c1">#    for idx in idcs:</span>
<span class="c1">#        c = rp[&#39;coords&#39;][idx] # coordinates of both 4-connected branchpoint pixels</span>
<span class="c1">#        Ibps[c[1,0], c[1,1]] = 0</span>
<span class="c1">#</span>
<span class="c1">#    # Finally, handle the cases where there are five branchpoints in a row/column,</span>
<span class="c1">#    # same method as for three in a row/column</span>
<span class="c1">#    idcs = np.where(rp[&#39;area&#39;]==5)[0]</span>
<span class="c1">#    for idx in idcs:</span>
<span class="c1">#        c = rp[&#39;coords&#39;][idx] # coordinates of both 4-connected branchpoint pixels</span>
<span class="c1">#        Ibps[c[1,0], c[1,1]] = 0</span>
<span class="c1">#        Ibps[c[3,0], c[3,1]] = 0</span>

    <span class="c1"># To wrap up, reconvolve with the updated branchpoint image to filter</span>
    <span class="c1"># branchpoints made removable by the previous filtering</span>
    <span class="n">Iconv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">filter2D</span><span class="p">(</span><span class="n">Ibps</span><span class="p">,</span> <span class="n">src_depth</span><span class="p">,</span> <span class="n">kern</span><span class="p">)</span>
    <span class="c1"># Remove unwanted branchpoints based on patterns</span>
    <span class="n">Irm_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">Iconv</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">rmvals</span><span class="p">))</span>
    <span class="n">rmy</span><span class="p">,</span> <span class="n">rmx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Irm_flat</span><span class="o">==</span><span class="mi">1</span><span class="p">),</span> <span class="n">Iconv</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">Ibps</span><span class="p">[</span><span class="n">rmy</span><span class="p">,</span> <span class="n">rmx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>


<span class="c1">#    plt.close(&#39;all&#39;)</span>
<span class="c1">#    rgh.imshowpair(Iskel,Ibps)</span>
<span class="c1">#    idcs = np.where(rp[&#39;area&#39;]&gt;2)</span>
<span class="c1">#    for idx in range(0,len(rp[&#39;area&#39;])):</span>
<span class="c1">#        plt.scatter(rp[&#39;coords&#39;][idcs[0][idx]][:,1],rp[&#39;coords&#39;][idcs[0][idx]][:,0])</span>


<span class="c1">#    Iremove = np.zeros(np.shape(Ibps), dtype=&#39;uint8&#39;)</span>
<span class="c1">#    src_depth = -1</span>
<span class="c1">#    for caseno in np.arange(1,9):</span>
<span class="c1">#        kern = rgh.bp_kernels(caseno)</span>
<span class="c1">#        filtered = cv2.filter2D(Ibps,src_depth,kern)</span>
<span class="c1">##        print(sum(sum(filtered)))</span>
<span class="c1">#        Iremove[np.uint8(filtered)&gt;11] = 1</span>
<span class="c1">#</span>
<span class="c1">#    Ibps[Iremove &gt; 0] = 0</span>
<span class="c1">#    bps = np.where(Ibps&gt;0)</span>

    <span class="k">return</span> <span class="n">Ibps</span></div>


<div class="viewcode-block" id="bp_kernels"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.bp_kernels">[docs]</a><span class="k">def</span> <span class="nf">bp_kernels</span><span class="p">(</span><span class="n">caseno</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Provides kernels for convolving with branchpoints image to remove special</span>
<span class="sd">    cases (where three branchpoints make an &quot;L&quot; shape). There are 8 possible</span>
<span class="sd">    orientations (or caseno&#39;s).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">kernel</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">if</span> <span class="n">caseno</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">kernel</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">caseno</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">kernel</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">caseno</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">kernel</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">caseno</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">kernel</span><span class="p">[[</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">caseno</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">kernel</span><span class="p">[[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">caseno</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">kernel</span><span class="p">[[</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">caseno</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">kernel</span><span class="p">[[</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">caseno</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">kernel</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">kernel</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span></div>


<div class="viewcode-block" id="skel_kernels"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.skel_kernels">[docs]</a><span class="k">def</span> <span class="nf">skel_kernels</span><span class="p">(</span><span class="n">caseno</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Provides kernels for convolving with skeleton image to remove the following case:</span>

<span class="sd">    0 0 0</span>
<span class="sd">    1 1 1</span>
<span class="sd">    0 1 0</span>

<span class="sd">    and its rotations. The center pixel would be removed as doing so</span>
<span class="sd">    does not break connectivity of the skeleton.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">kernel</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># &quot;T&quot; cases</span>
    <span class="k">if</span> <span class="n">caseno</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># up</span>
        <span class="n">kernel</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">caseno</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># right</span>
        <span class="n">kernel</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">caseno</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># down</span>
        <span class="n">kernel</span><span class="p">[[</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">caseno</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># left</span>
        <span class="n">kernel</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">kernel</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span></div>


<span class="k">def</span> <span class="nf">skel_pixel_curvature</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">nwalk</span> <span class="o">=</span> <span class="mi">4</span><span class="p">):</span>

<span class="c1"># Takes an input skeleton and provides an estimate of the curvature at each</span>
<span class="c1"># pixel. Not all pixels are considered; some boundary pixels (i.e. those</span>
<span class="c1"># near the end of the skeleton) will not be computed. The more pruned and</span>
<span class="c1"># thinned the input skeleton, the less likely that any strange values will</span>
<span class="c1"># be returned. This code was written so that strange cases are merely</span>
<span class="c1"># skipped.</span>
<span class="c1">#</span>
<span class="c1"># Given an input skeleton image, the code looks at each pixel and fits a</span>
<span class="c1"># trendline through npix pixels &quot;upstream&quot; and &quot;downstream&quot; of the pixel in</span>
<span class="c1"># question. Scale is therefore set by npixels; larger will reduce</span>
<span class="c1"># variability in the curvature estimates.</span>
<span class="c1">#</span>
<span class="c1"># INPUTS:      Iskel - binary image of skeleton whose pixels you want</span>
<span class="c1">#                      curvature values</span>
<span class="c1">#</span>
<span class="c1"># OUTPUTS:         I - image of skeleton with curvature values at pixels</span>



    <span class="c1"># Pad the image to avoid boundary problems</span>
    <span class="c1"># NOT DONE HERE</span>

    <span class="c1"># Get coordinates of skeleton pixels</span>
    <span class="n">skelpix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">Iskel</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">tolist</span><span class="p">(</span><span class="n">skelpix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">tolist</span><span class="p">(</span><span class="n">skelpix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Initialize storage image</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">I</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="c1"># Loop through each pixel to compute its curvature</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">):</span>

<span class="c1">#        j = 500</span>
<span class="c1">#        x = px[j]</span>
<span class="c1">#        y = py[j]</span>

        <span class="n">nvals</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nvals</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># Only compute curvature if there are only two directions to walk</span>
            <span class="k">continue</span>

        <span class="n">walkdirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nvals</span><span class="p">)</span> <span class="k">if</span> <span class="n">q</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">walks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># Walk in both directions</span>
            <span class="n">wdir</span> <span class="o">=</span> <span class="p">{</span><span class="n">walkdirs</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span>
            <span class="n">xwalk</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="n">ywalk</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nwalk</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">wdir</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">xwalk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xwalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">ywalk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ywalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">rmdir</span> <span class="o">=</span> <span class="p">{</span><span class="mi">7</span><span class="p">}</span>
                <span class="k">elif</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">wdir</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">xwalk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xwalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">ywalk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ywalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">rmdir</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">}</span>
                <span class="k">elif</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">wdir</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">xwalk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xwalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">ywalk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ywalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">rmdir</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">}</span>
                <span class="k">elif</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">wdir</span><span class="p">))</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">xwalk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xwalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">ywalk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ywalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">rmdir</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">}</span>
                <span class="k">elif</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">wdir</span><span class="p">))</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">xwalk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xwalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">ywalk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ywalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">rmdir</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">}</span>
                <span class="k">elif</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">wdir</span><span class="p">))</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">xwalk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xwalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">ywalk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ywalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">rmdir</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">}</span>
                <span class="k">elif</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">wdir</span><span class="p">))</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">xwalk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xwalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">ywalk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ywalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">rmdir</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">}</span>
                <span class="k">elif</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">wdir</span><span class="p">))</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="n">xwalk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xwalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">ywalk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ywalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">rmdir</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span>

                <span class="n">nxtvals</span> <span class="o">=</span> <span class="n">neighbor_vals</span><span class="p">(</span><span class="n">Iskel</span><span class="p">,</span> <span class="n">xwalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ywalk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">wdir</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nxtvals</span><span class="p">)</span> <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">1</span><span class="p">}</span>
                <span class="n">wdir</span> <span class="o">=</span> <span class="n">wdir</span> <span class="o">-</span> <span class="n">rmdir</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wdir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">wdir</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">walks</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">xwalk</span><span class="p">,</span> <span class="n">ywalk</span><span class="p">])</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="n">nwalk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">walks</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">xwalk</span><span class="p">,</span> <span class="n">ywalk</span><span class="p">])</span>


        <span class="c1"># Now compute curvature using angle between lines fit through pixel walks</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">walks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">walks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">walks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Initialize values</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Make vectors emanting from origin</span>
        <span class="n">xs1</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="n">walks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">walks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">ys1</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="o">-</span> <span class="n">walks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">walks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">xs2</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="n">walks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">walks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">ys2</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="o">-</span> <span class="n">walks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">walks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>

        <span class="c1"># Check for straight-line segments (can&#39;t polyfit to them)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">xcheck</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">xcheck</span> <span class="ow">in</span> <span class="n">xs1</span><span class="p">):</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ys1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">ycheck</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">ycheck</span> <span class="ow">in</span> <span class="n">ys1</span><span class="p">):</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xs1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">xcheck</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">xcheck</span> <span class="ow">in</span> <span class="n">xs2</span><span class="p">):</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ys2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">y2</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">ycheck</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">ycheck</span> <span class="ow">in</span> <span class="n">ys2</span><span class="p">):</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xs2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># Fit line to walked paths; no intercept as lines must intersect at the origin</span>

        <span class="c1"># Reduce to vectors with base pixel as origin</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">xs1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">ys1</span><span class="p">):</span>
                <span class="n">w1fit</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xs1</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ys1</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)]</span>
                <span class="n">m1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">w1fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w1fit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">walks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">walks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">dx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dx</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">dx</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="o">-</span><span class="n">m1</span> <span class="o">*</span> <span class="n">dx</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w1fit</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ys1</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xs1</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)]</span>
                <span class="n">m1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">w1fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w1fit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">walks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">walks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="n">dy</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="o">-</span><span class="n">m1</span> <span class="o">*</span> <span class="n">dy</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">xs2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">ys2</span><span class="p">):</span>
                <span class="n">w2fit</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xs2</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ys2</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)]</span>
                <span class="n">m2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">w2fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w2fit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">walks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">walks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">dx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dx</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">dx</span>
                <span class="n">y2</span> <span class="o">=</span> <span class="o">-</span><span class="n">m2</span> <span class="o">*</span> <span class="n">dx</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w2fit</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ys2</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xs2</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)]</span>
                <span class="n">m2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">w2fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">w2fit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">walks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">walks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">y2</span> <span class="o">=</span> <span class="n">dy</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="o">-</span><span class="n">m2</span> <span class="o">*</span> <span class="n">dy</span>

        <span class="c1"># Flip second vector so it emanates from origin</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="o">-</span><span class="n">x2</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="o">-</span><span class="n">y2</span>

        <span class="n">dot</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">y2</span>
        <span class="n">det</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">x2</span>

        <span class="c1"># Store the curvature value</span>
        <span class="n">I</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">det</span><span class="p">,</span><span class="n">dot</span><span class="p">)</span><span class="o">*</span><span class="mi">360</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">I</span>


<div class="viewcode-block" id="hand_clean"><a class="viewcode-back" href="../../apiref/rivgraph.html#rivgraph.im_utils.hand_clean">[docs]</a><span class="k">def</span> <span class="nf">hand_clean</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;erase&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows user to hand-draw regions of interest on a binary mask that can</span>
<span class="sd">    either be filled (set to True) or erased (set to False).</span>

<span class="sd">    Interact with plot via the following:</span>
<span class="sd">        left-click: save a vertex of the polygon</span>
<span class="sd">        right-click: remove the last point (useful when zooming/panning)</span>
<span class="sd">        enter key: stop recording points</span>

<span class="sd">    Possible actions are &#39;erase&#39; (default) and &#39;fill&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

    <span class="k">def</span> <span class="nf">make_mask</span><span class="p">(</span><span class="n">Ishape</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span>
        <span class="n">Imask</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Ishape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Ishape</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">Imask</span><span class="p">)</span><span class="o">.</span><span class="n">polygon</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Imask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>


    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>

    <span class="n">coordssave</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ginput</span><span class="p">(</span><span class="n">n</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">show_clicks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create polygon mask from selected coordinates</span>
    <span class="n">Imask</span> <span class="o">=</span> <span class="n">make_mask</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">coordssave</span><span class="p">)</span>

    <span class="c1"># Apply polygon mask</span>
    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;erase&#39;</span><span class="p">:</span>
        <span class="n">I</span><span class="p">[</span><span class="n">Imask</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;fill&#39;</span><span class="p">:</span>
        <span class="n">I</span><span class="p">[</span><span class="n">Imask</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">I</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, J. Schwenk &amp; J. Hariharan

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>